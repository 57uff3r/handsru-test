# handsru-test

![](demo.svg)

## БД

Для мигрирования стуктуры БД используется _yoyo_. Миграции пишутся вручную для того, чтобы полностью контролировать стуктуру 
СУБД и индексы. Внешние ключи не используются чтобы повысить производительность БД.

Мигрируем базу данных командой из корня проекта.

```bash
yoyo apply --database postgresql://localhost:5432/handsr
```

В качестве ORM используется _peewee_. Для скоростного боевого кода это не самое лучшее решение, лучше чистый _asyncpg_
 или _pony_. Мигрировать можно и другими способами, конечно.    

## Структура таблиц

Минимальный набор, отвечающий поставленной задаче — список компаний в одной таблице и список связанных 
контактных страниц в другой. 


## Сбор данных

* Вынимаем некоторое количество записей из базы, по которым нужно пройтись. Выниманем их с помощью запроса в БД, в который
 передаем параметры, по которым выбираются записи. Это сделано для того, чтобы можно было раскидать задачи по разным серверам — допустим, сервер 
 №1 обходит первый миллион адресов, сервер №2 - второй. Разбивка в коде самая примитивная, просто показать принцип. 
* На основе считанных записей формируется список адресов для обхода. Размер списка адресов фактически задает количество корутин для многозадачного
 опроса страниц. Подбор и тесты размера пула корутин позволяет добиться максимальной скорости, в нашем же случае там по дефолту получается 10 или меньше.
* Создаем список задач на загруку страниц и отдаем их в _asyncio_. _Asyncio_ отдает результаты по готовности и идет выполнять 
запросы дальше, а мы ловим  готовые ответы и потрошим их на предмет наличия телефонов.


##  Парсинг

Из скачанного HTML вырезаем чистый текст. Сперва попробовал _bs4_, но он выдавал еще и JS/CSS. Чистить это все лень,
 поэтому извлечение текста идет мелкой либой, дающей более-менее чистый результат сразу из коробки.

По тексту идем известной регуляркой `((8|\+7)[\- ]?)?(\(?\d{3}\)?[\- ]?)?[\d\- ]{7,10}`, она жует номера форматов

```
+79261234567
89261234567
79261234567
+7 926 123 45 67
8(926)123-45-67
123-45-67
9261234567
79261234567
(495)1234567
(495) 123 45 67
89261234567
8-926-123-45-67
8 927 1234 234
8 927 12 12 888
8 927 12 555 12
8 927 123 8 123
``` 

В коде предусмотрена обработка текста несколькими регулярками, на всякий случай.  На выходе получается список телефон и 
иногда пролетает мусор, который подпадает под регулярку, но телефоном не является (строки типа *2011-2014*). Можно усложить регулярку,
 но она станет сильно сложее для понимания, поэтому мусор легко чистится простой эвристикой.
 
Регулярки испльзуем в компилированном виде, так они срабатывают раза в 2-3 быстрее. 
 
Все, получается список телефонов с каждого URL. 
 
